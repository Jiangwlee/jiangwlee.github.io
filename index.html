<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Welcome to my blog!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Welcome to my blog!">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Welcome to my blog!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Welcome to my blog!">
  
    <link rel="alternative" href="/atom.xml" title="Welcome to my blog!" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <script src="/style.js"></script>
  

</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="https://avatars3.githubusercontent.com/u/1829883?v=3&amp;amp;s=466" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Bruce Li</a></h1>
		</hgroup>

		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
				<li><a href="/tags/安全/">安全</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/Jiangwlee" title="github">github</a>
		        
					<a class="linkedin" target="_blank" href="http://www.linkedin.com/in/%E6%B1%9F%E7%BB%B4-%E6%9D%8E-86581392?trk=hp-identity-name" title="linkedin">linkedin</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">Bruce Li</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="https://avatars3.githubusercontent.com/u/1829883?v=3&amp;amp;s=466" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Bruce Li</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/tags/随笔/">随笔</a></li>
		        
					<li><a href="/tags/安全/">安全</a></li>
		        
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/Jiangwlee" title="github">github</a>
			        
						<a class="linkedin" target="_blank" href="http://www.linkedin.com/in/%E6%B1%9F%E7%BB%B4-%E6%9D%8E-86581392?trk=hp-identity-name" title="linkedin">linkedin</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        
  
    <article id="post-post" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/30/post/">Scrapy小记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>好多年前就尝试过Scrapy。但是那个时候编程经验尚浅，对于python和web的了解都非常粗浅，所以对于Scrapy的兴趣在几次很小的挫折后便失去了动力。如今故态萌发，于是重新研究，经过几天的折腾，终于对Scrapy有了一个初步印象。Scrapy的确是一个优秀的爬虫框架。有的人可能会想，写一个简单的爬虫为什么需要Scrapy，用urllib和beautifulsoup不也可以玩得很好吗？是的，urllib和beautifulsoup是可以玩得很好，而且起始的学习难度也要小很多。但是随着经验的增加，未免会遇到更复杂的场景，需要更复杂的爬虫，这时候Scrapy这样的框架就逐步体现出自己的优势：</p>
<ul>
<li>首先，Scrapy有许多现成的“轮子”。比如LinkExtractor，又比如对重复链接的处理机制。它们可以降低开发的难度，提高开发的效率，避免把开发者陷入与业务无关的技术细节中难以自拔。</li>
<li>其次，Scrapy有较好的可调试性。自己从零开始写一个Crawler，通常不会一开始就考虑如何调试代码。鬼知道能不能写出来，哪里犯得着一开始就写调试代码呢。而Scrapy则比较好调试，它既有一个很方便的Scrapy<br>Shell，还可以在代码中添加不同级别的调试信息，而且还可以通过Scrapy命令行参数来控制调试代码的输出。有这么好的功能为什么不用呢？</li>
<li>最后，由于Scrapy的流行程度较高，针对Scrapy的插件也更多，各种疑难杂症也很容易在网络上找到答案。</li>
</ul>
<p>一旦上手Scrapy，经过几个小项目的锻炼，再写新的爬虫就要轻松多了。好了，废话少说，转入正题。</p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>水木清华的贴图板块经常会有一些很有意思的贴图。但是这个网站做得很烂，烂到什么程度呢？互联网都发展这么多年了，这个网站居然还无法在帖子中直接播放gif动图。每次想要看一下动图，我需要首先点一下图片，然后浏览器会弹出一个新的Tab页，然后在其中播放图片。这一点已经到了让人发指的程度，然而更让人崩溃的是在新Tab页中加载图片的速度慢如蜗牛爬山。如果用的不是IE浏览器，而用Firefox或者Chrome的话，那么非常抱歉，这两款非常注重安全的浏览器根本不会让你打开图片。具体原因不清楚，根据弹出来的提示，大约是图片所在的子站不安全。所以，对于只想安安静静看几张图片的我来说，也只能考虑写个爬虫来帮帮忙了。</p>
<h3 id="初探Scrapy"><a href="#初探Scrapy" class="headerlink" title="初探Scrapy"></a>初探Scrapy</h3><p>Scrapy的官方文档上有一张很好的图片，解释了Scrapy的工作机理：</p>
<p><img src="https://doc.scrapy.org/en/latest/_images/scrapy_architecture_02.png" alt="Scrapy_architecture"></p>
<p>其中每一步的涵义如下：</p>
<ol>
<li>Engine从Spider那里获取到要爬取的初始目标</li>
<li>Engine将请求交给调度器(Scheduler)来调度，然后询问调度器下一个爬取的请求</li>
<li>调度器将下一个要爬取的请求返回给Engine</li>
<li>Engine将请求发送给下载器(Downloader)，在这一过程中，所有的请求要首先经过Downloader中间件的处理</li>
<li>一旦下载器完成了页面的下载，它将生成一个Response，经过Downloader中间件的处理后将结果返回给Engine</li>
<li>Engine将收到的Response转发给Spider来处理，在这一过程中，所有的Response要首先经过Spider中间件的处理</li>
<li>Spider对Response进行处理，将生成的ITEM或者新的请求提交给Engine，这一过程中，所有的ITEM和请求都会首先被Spider中间件处理</li>
<li>Engine将ITEM交给ITEM PIPELINES，将新的请求交给调度器</li>
<li>这一过程不断重复，直至调度器中没有任何新的请求</li>
</ol>
<p>从Scrapy的架构图上来看，它的整个工作机理是非常清晰的。主要的参与者有Spider, Engine, Scheduler, Downloader, Item Pipelines。其中Engine, Scheduler和Downloader是几乎不需要打交道的。对于开发者而言，只需要关注Spider, ItemPipelines, Downloader Middleware和Spider Middleware。这四者的分工是这样的：</p>
<ol>
<li>Spider: 生成结果(Item)和请求(Request)</li>
<li>ItemPipelines: 对Item做进一步的处理，比如存储图片或者文件等</li>
<li>Downloader Middleware: 对HTTP Request和Response做一些修改和处理</li>
<li>Spider Middleware: 处理Spider生成的Request和Item</li>
</ol>
<p>关于怎么写一个简单的Crawler，Scrapy的官方文档有很详细的介绍，网上也有诸多例子，这里就不赘述了。一旦理解了上面这张图，写Crawler便成为一件简单轻松的事情。</p>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><p>理想很丰满，现实很骨感。书上不会告诉你全部的真相！</p>
<p>我一开始就碰壁了。用Scrapy下载的网页和我从浏览器中看到的完全不同。我在Scrapy Shell中，看到的是一堆Javascript代码，而在浏览器中则是丰富的网页。Google了才知道Scrapy只是一个框架，不具备网页渲染的能力。因此，对于需要进行客户端计算的动态网页，只能寻求其他工具的帮助。经过对比，我选择了Splash。Splash是一个很高效的轻量级浏览器。它安装方便，直接在docker中运行，而且还提供了许多的HTTP<br>API来获取不同类型的渲染结果。在Github上有一个开源项目，叫做Scrapy-Splash，提供了一套Middleware将Scrapy和Splash胶合在一起，用起来非常方便。</p>
<p>通过Splash终于解决了动态网页的问题。接下来是页面爬取和图片保存。最后结果一看，通过Scrapy的ImagesPipeline保存的图片全部都变成了jpg格式。原来ImagesPipeline会自动将所有图片文件都保存成.jpg格式。又是辛苦的Google，并没有太好的办法，最终是在Scrapy的github里看到有好心人回复，建议通过继承ImagesPipeline并重写其中的一些方法来保存gif文件。好在ImagesPipeline的代码比较简单，啃了半天后我重写了其中的一些方法，顺便将不同帖子中的图片放在不同的目录下。</p>
<p>具体的代码在我的github上：<a href="https://github.com/Jiangwlee/Spiders" target="_blank" rel="external">https://github.com/Jiangwlee/Spiders</a></p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>2016年马上就要过去了，这一年变化很多，还来不及总结，希望2017年能有更多的收获吧！</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/12/30/post/" class="archive-article-date">
  	<time datetime="2016-12-30T07:03:36.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-12-30</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Scrapy-Crawler-Spider-爬虫/">Scrapy, Crawler, Spider, 爬虫</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
    <article id="post-hello" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/18/hello/">序</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>好久没有写Blog了，第一篇也不知道写什么好，先Hello吧，希望能够坚持下去！</p>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/10/18/hello/" class="archive-article-date">
  	<time datetime="2016-10-18T09:27:28.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-10-18</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
	</div>

      

      <div class="clearfix"></div>
    </div>
  </div>
</article>










  
  


      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Bruce Li
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/",
		innerArchive: true
	}
</script>

<script src="/./main.js"></script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/Scrapy-Crawler-Spider-爬虫/" style="font-size: 10px;">Scrapy, Crawler, Spider, 爬虫</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://litten.github.io/">Litten的Blog</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">庄子有云，不积跬步，无以至千里，不积小流，无以成江海。学习一事，历来没有捷径，无外乎勤奋与积累。在任何一个领域，做得时间长了，若善于总结与提炼便可以成为一方专家。吾本愚钝，唯日夜不辍于学，方能独立于世。特开此博，记录学习点滴，帮助有缘之人，共同进步，共勉之！</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>